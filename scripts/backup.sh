#!/bin/bash

# ะะพะฝัะธะณััะฐัะธั
BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_FILE="data/scheduler.db"

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

success() { echo -e "${GREEN}โ $1${NC}"; }
error() { echo -e "${RED}โ $1${NC}"; }
info() { echo -e "${BLUE}๐น $1${NC}"; }

# ะกะพะทะดะฐัะผ ะดะธัะตะบัะพัะธั ั ะฟัะฐะฒะธะปัะฝัะผะธ ะฟัะฐะฒะฐะผะธ
mkdir -p "$BACKUP_DIR"
chmod 755 "$BACKUP_DIR" 2>/dev/null || true

echo "๐ ะกะพะทะดะฐะฝะธะต ะฑะตะบะฐะฟะฐ ะฑะฐะทั ะดะฐะฝะฝัั..."

# ะัะพะฒะตััะตะผ ััะพ ัะฐะนะป ะฑะฐะทั ัััะตััะฒัะตั
if [ ! -f "$DB_FILE" ]; then
    error "ะคะฐะนะป ะฑะฐะทั ะดะฐะฝะฝัั $DB_FILE ะฝะต ะฝะฐะนะดะตะฝ"
    info "ะฃะฑะตะดะธัะตัั ััะพ ะฟัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ ะธ ะฑะฐะทะฐ ัะพะทะดะฐะฝะฐ"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะดะพัััะฟ ะบ ัะฐะนะปั ะฑะฐะทั
if [ ! -r "$DB_FILE" ]; then
    error "ะะตั ะดะพัััะฟะฐ ะดะปั ััะตะฝะธั ัะฐะนะปะฐ ะฑะฐะทั ะดะฐะฝะฝัั"
    info "ะะพะฟัะพะฑัะนัะต: sudo chmod 644 $DB_FILE"
    exit 1
fi

# ะกะพะทะดะฐะตะผ ะฑะตะบะฐะฟ
info "ะะพะฟะธัะพะฒะฐะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั..."
if cp "$DB_FILE" "$BACKUP_DIR/scheduler_${DATE}.db"; then
    # ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฝะพัะผะฐะปัะฝัะต ะฟัะฐะฒะฐ ะฝะฐ ะฑะตะบะฐะฟ (ัะธัะฐะตะผัะน ะดะปั ะฒัะตั)
    chmod 644 "$BACKUP_DIR/scheduler_${DATE}.db" 2>/dev/null || true
    
    success "ะะตะบะฐะฟ ัะพะทะดะฐะฝ: $BACKUP_DIR/scheduler_${DATE}.db"
else
    error "ะัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฑะตะบะฐะฟะฐ"
    exit 1
fi

# ะกัะฐัะธััะธะบะฐ
echo ""
success "๐ ะะตะบะฐะฟ ััะฟะตัะฝะพ ัะพะทะดะฐะฝ:"
info "   ๐๏ธ  ะคะฐะนะป: $BACKUP_DIR/scheduler_${DATE}.db"
info "   ๐ ะะฐะทะผะตั: $(du -h "$BACKUP_DIR/scheduler_${DATE}.db" | cut -f1)"
info "   ๐ ะะฐัะฐ: $(date +"%d.%m.%Y %H:%M")"

# ะะฝัะพัะผะฐัะธั ะพ ะฑะตะบะฐะฟะฐั
BACKUP_COUNT=$(find "$BACKUP_DIR" -name "*.db" -type f 2>/dev/null | wc -l)
echo ""
info "๐ ะัะตะณะพ ะฑะตะบะฐะฟะพะฒ: $BACKUP_COUNT"